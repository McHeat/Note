<!DOCTYPE HTML>
<html>
<head>
	<title>SpringCloud Netflix</title>
	<style>
	body {
		width: 60%; 
		margin: auto;
		background-color: #b9a31242;
	}
	h1 {
		color: orange;
		text-align: center;
	}
	p {
		font-family: "sans-serif";
		font-size: 16px;
		text-indent: 2em
	}
	pre {
		font-family: "sans-serif";
		font-size: 14px;
	}
	.withborder {
		border-color: azure;
		border: 1px solid;
		border-radius: 5px;
	}
	</style>
</head>
<body>
<h1>SpringCloud Netflix</h1>
<hr>
<p>Spring Cloud Netflix通过自动配置和绑定Spring Environment及其他Spring编程模型风格将Spring Boot应用中集成到Netflix OSS平台。通过简单的几个注解，就可以快速地启动和配置应用中的一些常用模式并借助Netflix组件搭建大型分布式系统。常用模式包括：</p>
	<ul>
		<li>服务发现&nbsp;Service Discovery (Eureka)</li>
		<li>断路器&nbsp;Circuit Breaker (Hystrix)</li>
		<li>智能路由&nbsp;Intelligent Routing (Zuul)</li>
		<li>客户端负载均衡&nbsp;Client Side Load Balancing (Ribbon)</li>
	</ul>
	<h1>Part Ⅰ. 服务发现&nbsp;Service Discovery</h1>
	<h2>Chapter.1&nbsp;服务发现&nbsp;Service Discovery：Eureka Client</h2>
	<p>Service Discovery是微服务框架的核心原则之一。Eureka是Netflix的服务发现的服务器和客户端，可高效地配置和部署，可从其他服务器复制注册服务的状态。</p>
	<h4>一、引入Eureka客户端</h4>
	<p>为了在项目中使用Eureka客户端，需使用org.springframework.cloud:spring-cloud-starter-eureka的starter。</p>
	<h4>二、在Eureka上注册</h4>
	<p>当在Eureka上注册后，客户端会向Eureka提供自身一些元数据，如host和port、健康检测URL、首页等。Eureka会从服务实例接收到心跳信息。如果超出配置时间表未收到心跳信息，实例会从注册中被移除。</p>
	<p>使用@EnableEurekaClient(仅Eureka时有效)或@EnableDiscoveryClient后，应用会自动向Eureka服务器注册。同时需添加相关配置：</p>
	<div class="withborder">
	<pre>
	eureka:
	  client:
	    serviceUrl:
	      defaultZone: http://localhost:8761/eureka/</pre>
	</div>
	<p>app不仅会注册为一个Eureka的实例，同时也会作为Eureka客户端查询注册来定位其他服务。实例可通过eureka.instance.*配置，如果已配置了spring.application.name时默认值已可满足需求。查阅EurekaInstanceConfigBean和EurekaClientConfigBean了解配置项详情。</p>
	<h4>三、Eureka服务器授权</h4>
	<p>如果eureka.client.serviceUrl.defaultZone配置的url内置了凭证，Eureka客户端会自动添加HTTP基本认证。如果更复杂的需求，请创建DiscoveryClientOptionalArgs的@Bean，在这个bean中注入ClientFilter实例，这些实例会应用到客服端发送到服务端的请求。</p>
	<h4>四、状态页和健康监控</h4>
	<p>Eureka实例默认的状态页面和健康监控器分别为“/info”和“/health”，这是spring boot actuator提供的默认终端点。修改默认地址：</p>
	<div class="withborder">
	<pre>
	eureka:
	  instance:
		statusPageUrlPath: ${management.context-path}/info
		healthCheckUrlPath: ${management.context-path}/health</pre>
	</div>
	<h4>五、注册为安全应用</h4>
	<p>如果想要通过HTTPS连接应用，可以通过EurekaInstanceConfig中的两个标记设置
	<pre>eureka.instance.[nonSecurePortEnabled, securePortEnabled]=[false, true]<br></pre>
	这会使Eureka发布的实例信息明确要求安全的会话。DiscoveryClient会为上述配置返回以https开头的URI的服务,Eureka实例信息也会创建安全的健康检查URL。</p>
	<p>由于Eureka内部的工作机制，如果未显式重写，Eureka仍然会发布非安全的状态页和首页URL。可通过占位符配置Eureka实例的地址：</p>
	<div class="withborder">
	<pre>
	eureka:
	  instance:
		statusPageUrl: https://${eureka.hostname}/info
		healthCheckUrl: https://${eureka.hostname}/health
		homePageUrl: https://${eureka.hostname}/</pre>
	</div>
	<h4>六、Eureka的健康检查</h4>
	<p>默认地， Eureka利用心跳判断客户端是否在线。在未特定说明的情况下，Discovery Client不会传递当前应用的健康检查状态。一旦成功注册后，Eureka会认为应用一直处于UP状态。通过设置
	<pre>eureka.client.healthcheck.enabled: true</pre>
	客户端会向Eureka传递应用状态，因此其他应用不会向非UP状态的应用引流。</p>
	<p>如果想更好地控制健康检查，可考虑实现自己的com.netflix.appinfo.HealthCheckHandler。</p>
	<h4>七、Eureka实例和客户端的元数据</h4>
	<p>主机名、IP地址、端口号、状态页面和健康检查都有标准的元数据，这些可以直接通过服务注册来发布，也可用于客户端连接服务。额外的元数据可以通过eureka.instance.metadataMap添加到实例注册信息中。这些元数据可在远程客户端使用，但在未声明元数据的意义时无法改变客户端行为。</p>
	<h5>在CloudFoundry上使用Eureka</h5>
	<p>Cloudfoundry包含一个全局的router，同一个应用的所有实例都有着同样的主机名。这并不会妨碍使用Eureka，但是如果想使用这个router，需明确地设置主机名和端口号（securePort|nonSecurePort）。</p>
	<div class="withborder"><pre>
	eureka:
	  instance:
	    hostname: ${vcap.application.uris[0]}
	    nonSecurePort: 80</pre>
	</div>
	<h5>在AWS上使用Eureka</h5>
	<p>如果应用想部署在AWS云平台，Eureka实例需通过自定义EurekaInstanceConfigBean：</p>
	<div class="withborder">
	<pre>
	@Bean                                                                                                
	@Profile("!default")                                                                                 
	public EurekaInstanceConfigBean eurekaInstanceConfig(InetUtils inetUtils) {                          
		EurekaInstanceConfigBean b = new EurekaInstanceConfigBean(inetUtils); 
		AmazonInfo info = AmazonInfo.Builder.newBuilder().autoBuild("eureka");
		b.setDataCenterInfo(info);
		return b;                                                                                        
	}</pre>
	</div>
	<h5>修改Eureka实例的ID</h5>
	<p>通常，Netflix Eureka实例的ID会与主机名一致，所以每个主机只有一个服务。Spring Cloud Eureka提供了默认值：${spring.cloud.client.hostname}:${spring.application.name}:${spring.application.instance_id:${server.port}}}。Spring Cloud通过eureka.instance.instanceId: xxxx来覆盖默认的实例ID，从而可在一台主机上部署多个服务。</p>
	<h4>八、使用EurekaClient</h4>
	<p>一旦你拥有一个发现服务客户端，就能够从Eureka服务器上发现服务实例。通过注入EurekaClient或DiscoveryClient的实例bean来实现，但不要在@PostConstruct或@Scheduled方法里使用EurekaClient。</p>
	<p>默认地，EurekaClient使用Jersey进行HTTP通信。如果要避免使用Jersey，你可以从依赖中排除Jersey。Spring Cloud会自动配置一个基于RestTemplate的传输通道。</p>
	<h4>九、原生Netflix EurekaClient的替代方案</h4>
	<p>原生的Netflix EurekaClient并不是必须的，有些包装类用起来可能更方便。Spring Cloud支持Feign和Spring RestTemplate来使用逻辑Eureka服务定位符而不是原生URL。org.springframework.cloud.client.discovery.DiscoveryClient也提供了同样的API，且不属于Netflix的特定实现。</p>
	<h4>十、为何注册服务很慢</h4>
	<p>注册为实例也包括向注册中心发送周期性的心跳，默认30s。实例、服务器和客户端在本地缓存中的元数据同步需要3次心跳，之后服务才会被客户端发现。通过eureka.instance.leaseRenewalIntervalInSeconds修改间隔时间，可加速客户端连接到其他服务的进程。在生产环境中保持该默认值可能会更好一些，因为在服务器内部需要一定的计算。</p>
	<h4>十一、Zones</h4>
	<p>没看懂</p>
	<h2>Chapter.2&nbsp;服务发现&nbsp;Service Discovery：Eureka Server</h2>
	<h4>一、引入Eureka服务器</h4>
	<p>为了在项目中使用Eureka客户端，需使用org.springframework.cloud:spring-cloud-starter-netflix-eureka-server的starter。</p>
	<h4>二、运行Eureka服务器</h4>
	<div class="withborder">
	<pre>
	@SpringBootApplication
	@EnableEurekaServer
	public class Application {

		public static void main(String[] args) {
			new SpringApplicationBuilder(Application.class).web(true).run(args);
		}
	}</pre>
	</div>
	<p>服务器会提供一个可视化的首页，Eureka功能的HTTP API都在/eureka/*下。</p>
	<h4>三、高可用性，Zone和Region</h4>
	<p>Eureka服务器没有后端存储，但是已注册的服务实例必须发送心跳保证更新注册信息(在内存中实现)。客户端也会在内存缓存中保存一份eureka注册信息，这样就不需要每个请求都访问注册中心。</p>
	
	
	
	
	
	
	
	
	
</body>
</html>

































	
	
	
	
	
	
	
	
	
	
	
	
	
	
	