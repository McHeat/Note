# RabbitMQ

## AMQ协议
### 一、AMQP作为一种RPC传输机制  
+ 与大多数RPC不同的是，AMQP规范中允许服务器和客户端都可以发出命令。  
+ 同时，AMQP规范定义了与RabbitMQ进行通信的信道。一个AMQP连接可以有多个信道，允许客户端和服务器之间进行多次会话。(多路复用)  

### 二、AMQP RPC帧结构  
1. AMQP帧由五个不同的组件组成：  
  + 帧类型  
  + 信道编号  
  + 以字节为单位的帧有效载荷大小  
  + 帧有效载荷  
  + 结束字节标识(ASCII值206-0xce)   
2. 帧类型：
  + **协议头帧**：连接RabbitMQ，仅使用一次  
  + **方法帧**：发送或接收RabbitMQ的RPC请求或响应   
  + **内容头帧**：消息的大小和属性
  + **消息体帧**：消息的内容
  + **心跳帧**：客户端与RabbitMQ之间的校验机制，确保连接可用且正常工作  
3. 帧的发送顺序：方法帧、内容头帧以及一个或多个消息体帧   

### 三、使用协议  
**交换器**和**队列**是AMQ模型中的一等公民。  
1. 声明交换器  
  使用Exchange.Declare命令可创建交换器，提供了定义交换器名称和类型的参数，以及用于消息处理的其他元数据。  
  RabbitMQ在创建了交换器之后将发送一个Exchange.DeclareOk方法帧作为响应。创建失败则使用Channel.Close命令关闭发送Exchange.Declare命令的信道，响应将包含一个数字回复编码和文本值，用以说明失败并关闭信道的原因。  
2. 声明队列  
  交换器创建成功后，发送Queue.Declare命令创建一个队列，如果执行失败同样会关闭信道。  
  在声明一个队列时，多次发送同一个Queue.Declare命令不会有任何副作用。RabbitMQ不会处理后续的队列声明，只会返回队列有关的有用信息。  
3. 绑定队列到交换器  
  Queue.Bind命令可指定一个队列绑定到指定的交换器，成功会收到Queue.BindOk方法帧。  
  